# WX849 协议接入指南

本文档介绍如何在 Dify-on-Wechat (dow-849) 项目中使用 WX849 独立通道进行微信接入。

## 1. 目录结构

```
dow-849/
├── channel/                    # 通道目录
│   ├── wx849/                  # WX849 独立通道
│   │   ├── __init__.py         # 包初始化文件
│   │   └── wx849_channel.py    # WX849 通道实现
│   └── ...
└── lib/
    └── wx849/                  # WX849 协议库
        ├── 849/                # 849 协议核心实现
        │   ├── pad/            # 849 协议服务（iPad版本）
        │   ├── pad2/           # 855 协议服务（安卓PAD版本）
        │   ├── pad3/           # iPad 新版协议服务 
        │   └── redis/          # Redis服务
        └── WechatAPI/          # WechatAPI接口实现
            ├── Client/         # 849协议客户端
            ├── Client2/        # 855协议客户端
            ├── Client3/        # iPad协议客户端
            └── Server/         # 服务端实现
```

## 2. 特点与优势

作为一个独立的通道（与 wx、wxy 等并列），WX849 通道具有以下特点：

- **完全独立**: 不依赖于 wechat 通道的实现，可以单独维护和升级
- **灵活配置**: 可以根据需要选择不同的协议版本 (849/855/ipad)
- **可扩展性**: 可以轻松添加新的特性和功能，而不影响其他通道
- **更好的代码组织**: 遵循项目的模块化架构，使代码更加清晰和易于维护

## 3. 使用方法

### 3.1 配置项目

1. 修改配置文件 `config.json`，添加以下配置项：

```json
{
  "channel_type": "wx849",  
  "wx849_api_host": "127.0.0.1",
  "wx849_api_port": 9000,
  "wx849_protocol_version": "849"
}
```

其中 `wx849_protocol_version` 可选值：
- `"849"`: 使用 iPad 版本协议
- `"855"`: 使用安卓 PAD 版本协议
- `"ipad"`: 使用新版 iPad 协议

### 3.2 启动服务

#### Windows 用户

1. 运行 `scripts/wx849_start.bat` 脚本启动 WX849 协议服务
2. 等待服务完全启动后，会显示二维码
3. 使用微信扫描二维码进行登录
4. 登录成功后，使用 `python app.py` 启动主程序

停止服务：
- 运行 `scripts/wx849_stop.bat` 脚本停止 WX849 协议服务

#### Linux/macOS 用户

1. 赋予脚本执行权限：`chmod +x scripts/wx849_*.sh`
2. 运行 `./scripts/wx849_start.sh` 脚本启动 WX849 协议服务
3. 等待服务完全启动后，会显示二维码链接
4. 使用微信扫描二维码进行登录
5. 登录成功后，使用 `python app.py` 启动主程序

停止服务：
- 运行 `./scripts/wx849_stop.sh` 脚本停止 WX849 协议服务

## 4. 故障排除

### 4.1 服务无法启动

1. 确保 Redis 已成功启动，并且端口 6379 未被占用
2. 确保 PAD 服务可以正常运行，检查相关错误信息
3. 确保目录结构正确，所有文件都已复制到对应位置

### 4.2 登录失败

1. 确保您的微信版本支持当前使用的协议
2. 尝试切换不同的协议版本（修改 `wx849_protocol_version` 配置）
3. 检查 PAD 服务日志，寻找可能的错误信息

### 4.3 消息接收失败

1. 确认微信客户端保持登录状态
2. 检查网络连接是否正常
3. 重启 PAD 服务和主程序

## 5. 注意事项

1. WX849 协议属于非官方实现，可能存在稳定性问题
2. 建议使用虚拟环境或容器运行，避免影响正常使用的微信客户端
3. 定期检查协议更新，适配新版本的微信客户端

## 6. 参考资料

- [dow-849 项目主页](https://github.com/your-username/dow-849)
- [原 xxxbot-pad 项目参考](https://github.com/NanSsye/xxxbot-pad) 